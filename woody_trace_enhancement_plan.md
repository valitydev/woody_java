# Woody Trace Enhancements — план обновления библиотеки

## Цель

Расширить `woody_java`, сфокусировавшись на поддержке дополнительных заголовков и расширенном экспорте контекста
(`X-Request-*`, `x-woody-*`, `traceparent`, RPC-метаданные и пользовательские данные) в MDC и downstream. HTTP-шлюзы
по-прежнему будут реализовывать собственный транспортный слой (например, через `woody-http-bridge`), но смогут
опираться на стандартный функционал `woody_java` без дублирования логики.

## Шаги

1. **Анализ текущего состояния**
    - Провести ревью `woody-java` (`woody-api`, `woody-thrift`) — где считываются заголовки (`THttpHeader`,
      `ContextInterceptor`, `TransportExtensionBundles`).
    - Зафиксировать текущий формат MDC (`MDCUtils`) и поддерживаемые ключи (`trace_id`, `span_id`, `deadline`,
      `otel_*`).

2. **Поддержка дополнительных заголовков**
    - Добавить константы/перечисления для `X-Request-ID`, `X-Request-Deadline`, `x-woody-meta-user-identity-*` и их
      устаревшие варианты, если отсутствуют.
    - Обновить парсер транспортного уровня (`THTransportInterceptor`, `TransportExtensionBundles`) так, чтобы эти
      заголовки корректно попадали в `TraceData` (service/client span, metadata).

3. **Расширение MDC**
    - Доработать `MDCUtils` или сопутствующие классы, чтобы в логах появлялись дополнительные поля:
        - `trace.rpc.server.*`, `trace.rpc.client.*` (service/function/url/deadline);
        - `request.id`, `traceparent.flags`, пользовательские метаданные.
    - Обеспечить совместимость с текущими сервисами (не ломая формат) и предусмотреть возможность отключения новых
      полей.

4. **Экспорт в исходящие заголовки**
    - Убедиться, что `THClientBuilder`/`TransportExtensionBundles` выставляют полный набор заголовков (`woody.*`,
      `x-woody-*`, `traceparent`, `X-Request-*`, meta user identity) при отправке downstream.
    - Добавить тесты на form/legacy заголовки.

5. **Тестирование**
    - Unit/Integration тесты на парсинг/экспорт заголовков и правильное заполнение `TraceData` и MDC.
    - Проверить backwards compat: сервисы, не отправляющие новых заголовков, продолжают работать.

6. **Документация**
    - Обновить README/контекст в репозитории `woody_java` с перечислением поддерживаемых заголовков и MDC-полей.
    - Добавить рекомендации по интеграции для сервисов (включая работу через отдельные HTTP-обвязки вроде
      `woody-http-bridge`).

## Результат

После реализации этого плана сервисы, использующие `woody_java`, смогут опираться на стандартные механизмы по работе с
заголовками и MDC: любой HTTP-/gRPC-/RPC-шлюз (включая `woody-http-bridge`) сможет подключать эту библиотеку без
ручного дублирования логики по обработке заголовков и наполнению MDC.
